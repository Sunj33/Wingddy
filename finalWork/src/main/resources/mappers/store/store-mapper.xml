<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="storeMapper">
	<resultMap type="Store" id="storeResultSet">
		<result column="SP_NO" property="spNo"/>
		<result column="FILE_NO" property="fileNo"/>
		<result column="SP_NAME" property="spName"/>
		<result column="SP_CONTENT" property="spCount"/>
		<result column="SP_PRICE" property="spPrice"/>
		<result column="AMOUNT" property="amount"/>
		<result column="VIEW_COUNT" property="viewCount"/>
		<result column="SP_ONECOM" property="spOnecom"/>
		<result column="SP_DAY" property="spDay"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_PATH" property="filePath"/>
		<result column="FILE_LEVEL" property="fileLevel"/>
		<!-- <collection property="changeName" resultMap="Attachment"></collection>
		<collection property="fileLevel" resultMap="Attachment"></collection>
		<collection property="filePath" resultMap="Attachment"></collection> -->
	</resultMap>
	<resultMap type="Attachment" id="AttachmentResultSet">
		<result column="FILE_NO" property="fileNo"/>
		<result column="MEMBER_NO" property="memberNo"/>
		<result column="ORIGIN_NAME" property="originName"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_LEVEL" property="fileLevel"/>
		<result column="FILE_PATH" property="filePath"/>
	
	</resultMap>
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*) FROM S_STORE WHERE AMOUNT > 0
	</select>
	<select id="selectList" resultMap="storeResultSet" resultType="Store">
			SELECT 
			    S.SP_NAME
			    ,S.SP_PRICE
			    ,S.VIEW_COUNT
			    ,S.SP_DAY   
			    ,S.FILE_NO
			    ,A.FILE_LEVEL
                ,A.FILE_PATH
                ,A.CHANGE_NAME
                
			FROM S_STORE S
			JOIN ATTACHMENT A  ON (S.FILE_NO= A.FILE_NO)
			WHERE A.FILE_LEVEL = 2
			AND AMOUNT > 0
			ORDER BY SP_DAY DESC
	
	</select>
	<insert id="insertStoreAttachment" parameterType="Attachment">
	INSERT 
		INTO	
				ATTACHMENT
				(FILE_NO
				,MEMBER_NO
				,ORIGIN_NAME
				,CHANGE_NAME
				,FILE_LEVEL
				,FILE_PATH)
		VALUES
				(#{fileNo}+1
				,#{memerNo}
				,#{originName}
				,#{changeName}
				,2
				,#{filePath})
	</insert>
	<insert id="insertStore"  parameterType="Store">
	INSERT 
		INTO
				S_STORE
				(SP_NO
				 ,FILE_NO
				,SP_NAME
				,SP_CONTENT
				,SP_PRICE
				,AMOUNT
				,SP_ONECOM
				,SP_DAY)
		VALUES
			(SEQ_SP_NO.NEXTVAL
			,#{fileNo}+1
			,#{spName}
			,#{spContent}
			,#{spPrice}
			,#{amount}
			,#{spOnecom}
			,SYSDATE)	
	
		
	</insert>
	<insert id="insertStoreText" parameterType="hashmap">
		INSERT
			INTO
				S_STORE
				(SP_NO
				 ,FILE_NO
				,SP_NAME
				,SP_CONTENT
				,SP_PRICE
				,AMOUNT
				,SP_ONECOM
				,SP_DAY)
		VALUES
			(SEQ_SP_NO.NEXTVAL
			,SEQ_FNO.NEXTVAL 
			,#{spName}
			,#{spContent}
			,#{spPrice}
			,#{amount}
			,#{spOnecom}
			,SYSDATE)		
	</insert>
	<select id="createFileNo" resultType="_int">
		SELECT SEQ_FNO.NEXTVAL FROM DUAL
	</select>
	<update id="inceraseCount">
		UPDATE
			S_STORE
		SET
			VIEW_COUNT = VIEW_COUNT+1
        WHERE
        	SP_NO=#{spNo}
    	AND
        	AMOUNT >0
		
	</update>
	<select id="selectStoreBoard"  resultMap="storeResultSet,AttachmentResultSet">
		        	SELECT 
				S.SP_NO
				,S.FILE_NO
				,S.SP_NAME
				,S.SP_CONTENT 
				,S.SP_PRICE
				,S.AMOUNT
				,S.VIEW_COUNT 
				,S.SP_ONECOM
				,S.SP_DAY 
                ,A.FILE_NO
                ,A.FILE_PATH
                ,A.CHANGE_NAME
                
		FROM
			S_STORE S
        JOIN ATTACHMENT A  ON (S.FILE_NO= A.FILE_NO)
        WHERE AMOUNT > 0
        AND SP_NO = #{spNo}
	
	</select>
</mapper>